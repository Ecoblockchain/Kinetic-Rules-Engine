{
   "dispatch": [{"domain": "www.google.com"}],
   "global": [{"emit": "\nKOBJ.watchDOM = function(selector,callBackFunc,time){    \tif(!KOBJ.watcherRunning){    \t\t\tKOBJ.log(\"Starting the DOM Watcher\");    \t\t\tif(!typeof(setInterval_native) == \"undefined\"){    \t\t\t\tvar KOBJ_setInterval = setInterval_native;    \t\t\t} else {    \t\t\t\tvar KOBJ_setInterval = setInterval;    \t\t\t}    \t\t\tif(KOBJ.watcherRunning){clearInterval(KOBJ.watcherRunning);}                            KOBJ.watcherData = [];                            KOBJ.watcherData.push({\"selector\": selector,\"callBacks\": [callBackFunc]});    \t\t\t$K(selector+\" :child:first\").addClass(\"KOBJ_AjaxWatcher\");    \t\t\tKOBJ.watcher = function(){    \t\t\t\t$K(KOBJ.watcherData).each(function(){    \t\t\t\t\tvar data = this;    \t\t\t\t\tvar selectorExists = $K(selector).length;    \t\t\t\t\tif(!selectorExists){return;}    \t\t\t\t\tvar hasNotChanged = $K(data.selector+\" :child:first\").is(\".KOBJ_AjaxWatcher\");    \t\t\t\t\tif(!hasNotChanged){    \t\t\t\t\t\t$K(data.callBacks).each(function(){    \t\t\t\t\t\t\tcallBack = this;    \t\t\t\t\t\t\tKOBJ.log(\"Running call back\");    \t\t\t\t\t\t\tcallBack();    \t\t\t\t\t\t});    \t\t\t\t\t\t$K(data.selector+\" :child:first\").addClass(\"KOBJ_AjaxWatcher\");    \t\t\t\t\t}    \t\t\t\t});    \t\t\t};    \t\t\tKOBJ.watcherRunning = KOBJ_setInterval(KOBJ.watcher,time||1000);    \t} else {    \t\t$K(KOBJ.watcherData).each(function(){    \t\t\tdataObj = this;    \t\t\tif(dataObj.selector == selector){    \t\t\t\tdataObj.callBacks.push(callBackFunc);    \t\t\t\t$K(selector+\" :child:first\").addClass(\"KOBJ_AjaxWatcher\");    \t\t\t\tKOBJ.log(\"DOM Watcher Callback for previous selector\",selector,\"added\");    \t\t\t\treturn false;    \t\t\t} else {    \t\t\t\tKOBJ.watcherData.push({\"selector\": selector,\"callBacks\": [callBackFunc]});    \t\t\t\t$K(selector+\" :child:first\").addClass(\"KOBJ_AjaxWatcher\");    \t\t\t\tKOBJ.log(\"DOM Watcher Call for new selector\",selector,\"added\");    \t\t\t}    \t\t});    \t}\t    };        KOBJ.annotate_local_search_extractdata = function(toAnnotate){    \t    \tvar annotateData = {};    \t    \tvar phoneTemp = $K(toAnnotate).find(\"nobr,.sc_hl1 li>:not(a),.tel,[id *= lblPhone]\").text().replace(/[\\u00B7() -]/g, \"\");    \tvar domainTemp = $K(toAnnotate).find(\".url\").text().replace(/www\\./,\"\");    \tif(domainTemp===\"\"){    \t\tdomainTemp = $K(toAnnotate).find(\"cite\").text().replace(/www\\./,\"\").replace(/[\\s-]/g,\"\");    \t}    \tif(phoneTemp===\"\"){    \t\tphoneTemp = $K(toAnnotate);    \t\tphoneTemp = phoneTemp.text().match(/\\(\\d{3}\\)\\s\\d{3}-\\d{4}/,\"$1\");    \t\tif(phoneTemp!==null){    \t\t\tphoneTemp = phoneTemp[0];    \t\t\tphoneTemp = phoneTemp.replace(/[() -]/g, \"\");    \t\t}    \t}            \tvar heightTemp = $K(toAnnotate).height();    \t    \tif(phoneTemp!==null){    \t\tannotateData[\"phone\"] = phoneTemp;    \t} else { annotateData[\"phone\"] = \"none\"; }    \tif(domainTemp!==null){    \t\tannotateData[\"domain\"] = domainTemp;    \t} else { annotateData[\"domain\"] = \"none\"; }    \tannotateData[\"height\"] = heightTemp;    \treturn annotateData;    };        KOBJ.annotate_local_search_defaults = {    \t\"name\": \"KOBJL\",    \t\"on_hash_change\": \"\",    \t\"domains\":{    \t\t\"www.google.com\":{\"selector\":\".g>.ts>tbody>tr>td:has(cite):not(:has(table)):not(:has(div)),#results td:last-child:has(h4):not(:has(table)):has(cite),.g table.ts tr td:last:not(:has(img)):has(cite),.g>table tbody tr td:has(h3):has(cite),.g>table tbody tr td table tr:has(.fl):has(cite)\",\"watcher\":\"#rso\"},    \t\t\"search.yahoo.com\":{\"selector\":\".res.sc-ng.sc-lc-bz-m div.content>ol>li,#yls-rs-res tbody tr .yls-rs-bizinfo,.vcard\",\"watcher\":null},    \t\t\"www.bing.com\":{\"selector\":\".sc_ol1li, #srs_orderedList>.llsResultItem\",\"watcher\":\"null\"}    \t}    };        KOBJ.annotate_local_search_results = function(annotate, config, cb) {    \tvar defaults = jQuery.extend(true, {}, KOBJ.annotate_local_search_defaults);        \tif (typeof config === 'object') {    \t\tjQuery.extend(true, defaults, config);    \t}    \t  \tif(defaults[\"domains\"][window.location.hostname]){    \t\tvar lister = defaults[\"domains\"][window.location.hostname][\"selector\"];    \t\tvar watcher = defaults[\"domains\"][window.location.hostname][\"watcher\"];    \t} else {    \t\treturn;    \t}        \tvar runAnnotateLocal = function(){    \t\tvar count = 0;    \t\t$K(lister).each(function() {        \t\t\tvar toAnnotate = this;    \t\t\t    \t\t\tvar extractedData = KOBJ.annotate_local_search_extractdata(toAnnotate);    \t\t\t$K.each(extractedData, function(name, value){    \t\t\t\t$K(toAnnotate).data(name, value);    \t\t\t});         \t\t\tvar contents = annotate(toAnnotate);    \t\t\tif (contents) {    \t\t\t\tcount++;    \t\t\t\t$K(\":last\",this).after(contents);    \t\t\t}    \t\t});        \t\tKOBJ.logger('annotated_search_results', config['txn_id'], count, '', 'success', config['rule_name'] );    \t\tcb();    \t};        \trunAnnotateLocal();        \t  \tif(watcher){    \t\tKOBJ.watchDOM(watcher, runAnnotateLocal);    \t}                };        KOBJ.annotate_local_search_results_withremote = function(remoteurl, config, cb) {    \tvar defaults = jQuery.extend(true, {}, KOBJ.annotate_local_search_defaults);        \tif (typeof config === 'object') {    \t\tjQuery.extend(true, defaults, config);    \t}    \t    \tif(defaults[\"domains\"][window.location.hostname]){    \t\tvar lister = defaults[\"domains\"][window.location.hostname][\"selector\"];    \t\tvar watcher = defaults[\"domains\"][window.location.hostname][\"watcher\"];    \t} else {    \t\treturn;    \t}        \tKOBJ.annotate_local_counter = KOBJ.annotate_local_counter || 0;    \tvar runAnnotateLocal = function(){    \t\tvar count = 0;    \t\tvar annotateInfo = {};    \t\t$K(lister).each(function() {    \t\t\tvar toAnnotate = this;        \t\t\tvar itemCounter = defaults['name'] + (KOBJ.annotate_local_counter += 1);    \t\t\t    \t\t\tannotateInfo[itemCounter] = KOBJ.annotate_local_search_extractdata(toAnnotate);    \t\t\t$K(toAnnotate).addClass(itemCounter);    \t\t});    \t\t    \t\tannotateString = $K.compactJSON(annotateInfo);    \t\tKOBJ.log(annotateString);    \t\t$K.getJSON(remoteurl, {'annotatedata':annotateString}, function(data){    \t        \tKOBJ.log(data);    \t\t\tcount = 0;        \t\t\t$K.each(data, function(key,contents){    \t\t\t\tKOBJ.log(key,contents,data);    \t\t\t\tif(contents){    \t\t\t\t\t$K(\".\"+key+\" :last\").after(contents);\t\t\t\t    \t\t\t\t}    \t\t\t\tcount++;    \t        \t});                                cb();    \t\t});        \t};    \trunAnnotateLocal();    \t  \tif(watcher){    \t\tKOBJ.watchDOM(watcher, runAnnotateLocal);    \t}    };                            "}],
   "meta": {
      "description": "\ndemo of annotating local results   \n",
      "logging": "off",
      "name": "AnnotateLocal"
   },
   "rules": [{
      "actions": [{"action": {
         "args": [],
         "modifiers": null,
         "name": "noop",
         "source": null
      }}],
      "blocktype": "every",
      "callbacks": null,
      "cond": {
         "type": "bool",
         "val": "true"
      },
      "emit": "\ndomaindata = {  \t'www.geneharvey.com': {'url':'www.geneharvey.com'},  \t'www.bobstowing.com': {'url':'www.bobstowing.com'}  };    phonedata = {  \t'8014929012': 'www.bobstowing.com'  };        function my_selector(obj){    var domain = $K(obj).find(\"cite\").text().substr(3);     var phone = $K(obj).find(\"nobr\").text().replace(/[() -]/g, \"\");    var d = domaindata[domain];    if(!d){      var p = phonedata[phone];      if(p){        d = domaindata[p];      }    }    if(d || Math.floor(Math.random()*3+1) == 1) {       return \"<img style='margin-top:1px; margin-left:5px; margin-bottom:-4px;' src='http://www.azigo.com/landing/bbb/images/ab-seal-horizontal-16.jpg'/>\";    } else {       false;    }  }    KOBJ.annotate_local_search_results(\"my_selector\", {}, function(){});           ",
      "foreach": [],
      "name": "local",
      "pagetype": {"event_expr": {
         "legacy": 1,
         "op": "pageview",
         "pattern": ".",
         "type": "prim_event",
         "vars": []
      }},
      "state": "active"
   }],
   "ruleset_name": "a8x17"
}
