#!/usr/bin/perl -w

use strict;
use warnings;
use lib qw(/web/lib/perl);


use Getopt::Std;
use File::Find::Rule;
use DateTime;
use Sys::Hostname;
use File::Basename;

# config
my $base_var = 'KOBJ_ROOT';
#my $base = $ENV{$base_var} || die "$base_var is undefined in the environment";

my $web_root_var = 'WEB_ROOT';
my $web_root = $ENV{$web_root_var} || 
    die "$web_root_var is undefined in the environment";

my $GZIP = '/bin/gzip';
my $RSYNC = '/usr/bin/rsync';
my @logdirs = ("$web_root/logs/kynetx");

my $tmpdir = "$web_root/tmp/kobj-logs";
mkdir $tmpdir unless(-e $tmpdir);

# global options
use vars qw/ %opt /;
my $opt_string = 'hm:u:vf';
getopts( "$opt_string", \%opt ); # or &usage();

my $machine = $opt{'m'} || 'unionstation.kobj.net';
my $unique = $opt{'u'} || hostname;
my $verbose = $opt{'v'};
my $finalize = $opt{'f'};
&usage() if $opt{'h'};


my $rule = File::Find::Rule->new;

$rule->or(
    $rule->new->directory->name('*.gz')->prune->discard,
    $rule->new->file->name( '*.log' )
);

# get all the files
my @files;
for my $dir ( @logdirs ) {
    push( @files, (-d $dir) ? $rule->in($dir) : $dir );
}

# sort files by creation time and remove the newest one
@files = sort {(stat($a))[10] cmp (stat($b))[10]} @files;
pop @files unless $finalize;

for my $file (@files) {
    print "Processing $file\n" if $verbose;
    system "sudo /bin/chown web $file";
    my $dir = dirname $file;
    my $name = basename $file;
    # new file name has unique machine ID
    my $nf = "$tmpdir/$unique-$name";
    system "sudo /bin/mv $file $nf" || warn "Couldn't move $file: $!";
    print "gzipping $nf\n" if $verbose;
    system  "$GZIP $nf\n";
}


my @tmpfiles = glob("$tmpdir/*.gz");
# only run rsync if there's something to transfer
if (int(@tmpfiles)) {
    my $rsync_cmd = 
	"$RSYNC -e ssh --remove-sent-files  " . 
	$tmpdir . "/*.gz " .
	"web@" . $machine . ":logs";
    print "Running $rsync_cmd\n" if $verbose;
    system $rsync_cmd
}



1;


sub usage {
    print STDERR <<EOF;

usage:  

    kobj_log_daemon -m MACHINE

Moves log files to the "logs" directory of user "web" on the specified 
machine using rsync.  The source files are deleted after they're moved.

Options are:

  -m M	: name of machine to move logs files to (default 'unionstation')
  -u U  : unique identifier for these log files
  -v    : vebose
  -f    : finalize; don't skip most recent file.  Ensure Web server 
          has been halted before using this switch.  

EOF

exit;


}

